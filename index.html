<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora Magica</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full bg-green-50"><!-- Aplicación Principal -->
  <div id="app-principal" class="min-h-full p-6"><!-- Header -->
   <div class="text-center mb-6">
    <h1 id="titulo-principal" class="text-4xl font-bold text-black">Calculadora Mágica</h1>
   </div>
   <div class="bg-white p-6 rounded-lg shadow-md border-2 border-green-600 mb-8">
    <h2 class="text-2xl font-bold text-black mb-4">Calculadora de Tasa</h2>
    <div class="flex items-center gap-4"><label class="text-black font-semibold">Tasa del Dólar (BsF):</label> <input type="number" id="tasa-dolar" class="border-2 border-green-500 rounded px-4 py-2 w-48 text-black" placeholder="Ej: 50.00" step="0.01"> <button id="btn-actualizar-tasa" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-semibold">Actualizar Tasa</button> <span id="tasa-actual" class="text-black font-bold text-xl"></span>
    </div>
   </div><!-- Navegación de Pestañas -->
   <div class="mb-6">
    <div class="flex space-x-1 bg-green-100 p-1 rounded-lg"><button id="tab-calculadora" class="flex-1 py-3 px-4 rounded-md font-semibold text-black bg-white border-2 border-green-600">Calculadora</button> <button id="tab-inventario" class="flex-1 py-3 px-4 rounded-md font-semibold text-black hover:bg-green-200">Inventario</button> <button id="tab-ventas" class="flex-1 py-3 px-4 rounded-md font-semibold text-black hover:bg-green-200">Ventas</button> <button id="tab-reportes" class="flex-1 py-3 px-4 rounded-md font-semibold text-black hover:bg-green-200">Reportes</button>
    </div>
   </div><!-- Contenido de Pestañas -->
   <div id="contenido-pestanas"><!-- Pestaña Calculadora -->
    <div id="pestana-calculadora" class="pestana-contenido">
     <div class="bg-white p-6 rounded-lg shadow-md border-2 border-green-600">
      <h2 class="text-2xl font-bold text-black mb-4">Calculadora de Tasa del Dólar</h2>
      <div class="space-y-4">
       <div class="flex items-center gap-4"><label class="text-black font-semibold">Tasa del Dólar (BsF):</label> <input type="number" id="tasa-dolar-calc" class="border-2 border-green-500 rounded px-4 py-2 w-48 text-black" placeholder="Ej: 50.00" step="0.01"> <button id="btn-actualizar-tasa-calc" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-semibold">Actualizar Tasa</button>
       </div>
       <div id="tasa-actual-calc" class="text-black font-bold text-xl bg-green-50 p-4 rounded"></div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <div class="bg-green-50 p-4 rounded">
         <h3 class="font-bold text-black mb-3">Convertir Dólares a Bolívares</h3>
         <div class="space-y-2"><input type="number" id="conv-dolares" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black" placeholder="Cantidad en $" step="0.01">
          <div id="resultado-bolivares" class="text-black font-semibold text-lg"></div>
         </div>
        </div>
        <div class="bg-green-50 p-4 rounded">
         <h3 class="font-bold text-black mb-3">Convertir Bolívares a Dólares</h3>
         <div class="space-y-2"><input type="number" id="conv-bolivares" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black" placeholder="Cantidad en BsF" step="0.01">
          <div id="resultado-dolares" class="text-black font-semibold text-lg"></div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Pestaña Inventario -->
    <div id="pestana-inventario" class="pestana-contenido hidden">
     <div class="bg-white p-6 rounded-lg shadow-md border-2 border-green-600">
      <h2 id="texto-inventario" class="text-2xl font-bold text-black mb-4">Inventario</h2><!-- Selector de Método -->
      <div class="mb-6">
       <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg"><button id="tab-escaner" class="flex-1 py-2 px-4 rounded-md font-semibold text-black bg-white border-2 border-green-600">📱 Escáner Código</button> <button id="tab-manual" class="flex-1 py-2 px-4 rounded-md font-semibold text-black hover:bg-gray-200">✏️ Manual</button>
       </div>
      </div><!-- Escáner de Código de Barras -->
      <div id="inv-escaner" class="mb-6 p-4 bg-blue-50 rounded border-2 border-blue-500">
       <h3 class="font-bold text-black mb-3">📱 Escáner de Código de Barras</h3>
       <div class="space-y-3">
        <div class="text-center"><button id="btn-iniciar-camara" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded font-bold text-lg mb-3">🎥 Iniciar Cámara</button> <button id="btn-detener-camara" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded font-bold text-lg mb-3 hidden">⏹️ Detener Cámara</button>
        </div>
        <div id="camara-container" class="hidden">
         <div class="relative bg-black rounded-lg overflow-hidden">
          <video id="video-camara" class="w-full h-64 object-cover"></video>
          <div class="absolute inset-0 flex items-center justify-center">
           <div class="border-2 border-red-500 w-64 h-16 bg-transparent"></div>
          </div>
          <div class="absolute top-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm">
           Enfoca el código de barras en el rectángulo rojo
          </div>
         </div>
         <canvas id="canvas-escaner" class="hidden"></canvas>
        </div>
        <div id="resultado-escaner" class="hidden bg-green-100 p-3 rounded border-2 border-green-500">
         <div class="font-bold text-black mb-2">
          ✅ Código Detectado:
         </div>
         <div id="codigo-detectado" class="text-black font-mono text-lg mb-3"></div><button id="btn-usar-codigo" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">Usar este Código</button> <button id="btn-escanear-otro" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold ml-2">Escanear Otro</button>
        </div>
        <div id="error-escaner" class="hidden bg-red-100 p-3 rounded border-2 border-red-500">
         <div class="font-bold text-red-700 mb-2">
          ❌ Error:
         </div>
         <div id="mensaje-error" class="text-red-700"></div>
        </div>
       </div>
      </div><!-- Agregar Manual -->
      <div id="inv-manual" class="mb-6 p-4 bg-green-50 rounded hidden">
       <h3 class="font-bold text-black mb-3">✏️ Agregar Producto Manual</h3>
       <div class="space-y-3">
        <div><label class="block text-black font-semibold mb-1">Código de Barras:</label> <input type="text" id="inv-codigo-barras" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black" placeholder="Código de barras (opcional)" readonly>
        </div>
        <div><label class="block text-black font-semibold mb-1">Nombre del Producto:</label> <input type="text" id="inv-nombre" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black" placeholder="Nombre">
        </div>
        <div><label class="block text-black font-semibold mb-1">Categoría:</label> <select id="inv-categoria" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black"> <option value="abarrotes">Abarrotes</option> <option value="aseo e higiene">Aseo e Higiene</option> <option value="granos">Granos</option> <option value="lacteos">Lácteos</option> <option value="bebidas">Bebidas</option> <option value="golosinas">Golosinas</option> <option value="miscelaneos">Misceláneos</option> </select>
        </div>
        <div class="grid grid-cols-2 gap-3">
         <div><label class="block text-black font-semibold mb-1">Precio ($):</label> <input type="number" id="inv-precio-dolar" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black" placeholder="0.00" step="0.01">
         </div>
         <div><label class="block text-black font-semibold mb-1">Precio (BsF):</label> <input type="number" id="inv-precio-bolivar" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black" placeholder="0.00" step="0.01">
         </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
         <div><label class="block text-black font-semibold mb-1">Cantidad:</label> <input type="number" id="inv-cantidad" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black" placeholder="0" min="0">
         </div>
         <div><label class="block text-black font-semibold mb-1">Unidad:</label> <select id="inv-unidad" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black"> <option value="unidades">Unidades</option> <option value="cajas">Cajas</option> <option value="paquetes">Paquetes</option> </select>
         </div>
        </div><button id="btn-agregar-producto" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">Agregar al Inventario</button>
       </div>
      </div>
      <div id="lista-inventario" class="space-y-2 max-h-96 overflow-y-auto"></div>
      <div id="limite-inventario" class="hidden mt-4 p-3 bg-red-100 border-2 border-red-500 rounded text-red-700 font-semibold">
       Límite máximo de 999 productos alcanzado. Elimina productos para agregar más.
      </div>
     </div>
    </div><!-- Pestaña Ventas -->
    <div id="pestana-ventas" class="pestana-contenido hidden">
     <div class="bg-white p-6 rounded-lg shadow-md border-2 border-green-600">
      <h2 id="texto-ventas" class="text-2xl font-bold text-black mb-4">Ventas</h2><!-- Selector de Tipo de Venta -->
      <div class="mb-6">
       <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg"><button id="tab-venta-inventario" class="flex-1 py-2 px-4 rounded-md font-semibold text-black bg-white border-2 border-green-600">Venta desde Inventario</button> <button id="tab-venta-manual" class="flex-1 py-2 px-4 rounded-md font-semibold text-black hover:bg-gray-200">Venta Manual</button>
       </div>
      </div><!-- Venta desde Inventario -->
      <div id="venta-inventario" class="mb-6 p-4 bg-green-50 rounded">
       <h3 class="font-bold text-black mb-3">Venta desde Inventario</h3><!-- Escáner para Ventas -->
       <div class="mb-4 p-3 bg-blue-50 rounded border-2 border-blue-500">
        <h4 class="font-bold text-black mb-2">📱 Escáner Rápido para Ventas</h4>
        <div class="flex gap-2 mb-3"><button id="btn-escaner-venta" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">🎥 Escanear Código</button> <button id="btn-detener-escaner-venta" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-semibold hidden">⏹️ Detener</button>
        </div>
        <div id="camara-venta-container" class="hidden mb-3">
         <div class="relative bg-black rounded-lg overflow-hidden">
          <video id="video-venta" class="w-full h-48 object-cover"></video>
          <div class="absolute inset-0 flex items-center justify-center">
           <div class="border-2 border-red-500 w-48 h-12 bg-transparent"></div>
          </div>
          <div class="absolute top-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm">
           Enfoca el código de barras
          </div>
         </div>
        </div>
        <div id="resultado-venta-escaner" class="hidden bg-green-100 p-3 rounded border-2 border-green-500">
         <div class="font-bold text-black mb-2">
          ✅ Producto Encontrado:
         </div>
         <div id="producto-encontrado-info" class="text-black mb-3"></div>
         <div class="flex gap-2"><button id="btn-agregar-escaneado" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">Agregar a Venta</button> <button id="btn-continuar-escaneando" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">Continuar Escaneando</button>
         </div>
        </div>
        <div id="error-venta-escaner" class="hidden bg-red-100 p-3 rounded border-2 border-red-500">
         <div class="font-bold text-red-700 mb-2">
          ❌ Error:
         </div>
         <div id="mensaje-error-venta" class="text-red-700"></div>
        </div>
       </div>
       <div class="space-y-3">
        <div><label class="block text-black font-semibold mb-1">Buscar Producto:</label> <input type="text" id="buscar-producto" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black" placeholder="Escribe para buscar producto o escanea código...">
        </div>
        <div><label class="block text-black font-semibold mb-1">Seleccionar Producto:</label> <select id="venta-producto" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black"> <option value="">-- Seleccionar --</option> </select>
        </div>
        <div><label class="block text-black font-semibold mb-1">Cantidad:</label> <input type="number" id="venta-cantidad" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black" placeholder="1" min="1">
        </div>
        <div><label class="block text-black font-semibold mb-1">Modo de Pago:</label> <select id="venta-pago" class="w-full border-2 border-green-500 rounded px-3 py-2 text-black"> <option value="pago movil">Pago Móvil</option> <option value="punto de venta">Punto de Venta</option> <option value="divisa">Divisa</option> <option value="bsf">BsF</option> </select>
        </div><button id="btn-agregar-venta" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">Agregar a la Venta</button>
       </div>
      </div><!-- Venta Manual -->
      <div id="venta-manual-form" class="mb-6 p-4 bg-blue-50 rounded hidden">
       <h3 class="font-bold text-black mb-3">Venta Manual (Producto no en Inventario)</h3>
       <div class="space-y-3">
        <div><label class="block text-black font-semibold mb-1">Nombre del Producto:</label> <input type="text" id="manual-nombre" class="w-full border-2 border-blue-500 rounded px-3 py-2 text-black" placeholder="Nombre del producto">
        </div>
        <div><label class="block text-black font-semibold mb-1">Categoría:</label> <select id="manual-categoria" class="w-full border-2 border-blue-500 rounded px-3 py-2 text-black"> <option value="abarrotes">Abarrotes</option> <option value="aseo e higiene">Aseo e Higiene</option> <option value="granos">Granos</option> <option value="lacteos">Lácteos</option> <option value="bebidas">Bebidas</option> <option value="golosinas">Golosinas</option> <option value="miscelaneos">Misceláneos</option> </select>
        </div>
        <div class="grid grid-cols-2 gap-3">
         <div><label class="block text-black font-semibold mb-1">Precio Unitario ($):</label> <input type="number" id="manual-precio-dolar" class="w-full border-2 border-blue-500 rounded px-3 py-2 text-black" placeholder="0.00" step="0.01">
         </div>
         <div><label class="block text-black font-semibold mb-1">Precio Unitario (BsF):</label> <input type="number" id="manual-precio-bolivar" class="w-full border-2 border-blue-500 rounded px-3 py-2 text-black" placeholder="0.00" step="0.01">
         </div>
        </div>
        <div><label class="block text-black font-semibold mb-1">Cantidad:</label> <input type="number" id="manual-cantidad" class="w-full border-2 border-blue-500 rounded px-3 py-2 text-black" placeholder="1" min="1">
        </div>
        <div><label class="block text-black font-semibold mb-1">Modo de Pago:</label> <select id="manual-pago" class="w-full border-2 border-blue-500 rounded px-3 py-2 text-black"> <option value="pago movil">Pago Móvil</option> <option value="punto de venta">Punto de Venta</option> <option value="divisa">Divisa</option> <option value="bsf">BsF</option> </select>
        </div><button id="btn-agregar-venta-manual" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">Agregar Venta Manual</button>
       </div>
      </div>
      <div id="items-venta" class="mb-4 space-y-2 max-h-64 overflow-y-auto"></div>
      <div class="bg-green-100 p-4 rounded mb-4">
       <div class="flex justify-between text-black font-bold text-lg"><span>Total en Dólares:</span> <span id="total-dolares">$0.00</span>
       </div>
       <div class="flex justify-between text-black font-bold text-lg"><span>Total en Bolívares:</span> <span id="total-bolivares">BsF 0.00</span>
       </div>
      </div>
      <div class="flex gap-3"><button id="btn-finalizar-venta" class="flex-1 bg-green-700 hover:bg-green-800 text-white px-4 py-3 rounded font-bold text-lg">Finalizar Venta</button> <button id="btn-eliminar-venta" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded font-bold text-lg">Eliminar Venta</button>
      </div>
     </div>
    </div><!-- Pestaña Reportes -->
    <div id="pestana-reportes" class="pestana-contenido hidden">
     <div class="bg-white p-6 rounded-lg shadow-md border-2 border-green-600">
      <h2 class="text-2xl font-bold text-black mb-4">📊 Reportes de Ventas</h2><!-- Filtros de Reportes -->
      <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-500 mb-6">
       <h3 class="font-bold text-black mb-3">🔍 Filtros de Búsqueda</h3>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><label class="block text-black font-semibold mb-1">Fecha Desde:</label> <input type="date" id="filtro-fecha-desde" class="w-full border-2 border-blue-500 rounded px-3 py-2 text-black">
        </div>
        <div><label class="block text-black font-semibold mb-1">Fecha Hasta:</label> <input type="date" id="filtro-fecha-hasta" class="w-full border-2 border-blue-500 rounded px-3 py-2 text-black">
        </div>
        <div><label class="block text-black font-semibold mb-1">Modo de Pago:</label> <select id="filtro-modo-pago" class="w-full border-2 border-blue-500 rounded px-3 py-2 text-black"> <option value="">Todos los métodos</option> <option value="pago movil">Pago Móvil</option> <option value="punto de venta">Punto de Venta</option> <option value="divisa">Divisa</option> <option value="bsf">BsF</option> </select>
        </div>
       </div>
       <div class="flex gap-3 mt-4"><button id="btn-aplicar-filtros" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-semibold">🔍 Aplicar Filtros</button> <button id="btn-limpiar-filtros" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded font-semibold">🗑️ Limpiar Filtros</button>
       </div>
      </div><!-- Resumen de Ventas -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
       <div class="bg-green-100 p-4 rounded-lg border-2 border-green-500">
        <div class="text-center">
         <div class="text-2xl font-bold text-green-700" id="total-ventas-count">
          0
         </div>
         <div class="text-sm text-green-600">
          Total Ventas
         </div>
        </div>
       </div>
       <div class="bg-blue-100 p-4 rounded-lg border-2 border-blue-500">
        <div class="text-center">
         <div class="text-2xl font-bold text-blue-700" id="total-ingresos-dolares">
          $0.00
         </div>
         <div class="text-sm text-blue-600">
          Ingresos en Dólares
         </div>
        </div>
       </div>
       <div class="bg-yellow-100 p-4 rounded-lg border-2 border-yellow-500">
        <div class="text-center">
         <div class="text-2xl font-bold text-yellow-700" id="total-ingresos-bolivares">
          BsF 0.00
         </div>
         <div class="text-sm text-yellow-600">
          Ingresos en Bolívares
         </div>
        </div>
       </div>
       <div class="bg-purple-100 p-4 rounded-lg border-2 border-purple-500">
        <div class="text-center">
         <div class="text-2xl font-bold text-purple-700" id="productos-vendidos">
          0
         </div>
         <div class="text-sm text-purple-600">
          Productos Vendidos
         </div>
        </div>
       </div>
      </div><!-- Botones de Exportación -->
      <div class="flex gap-3 mb-6"><button id="btn-exportar-excel" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded font-bold">📊 Exportar a Excel</button> <button id="btn-exportar-pdf" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded font-bold">📄 Exportar a PDF</button> <button id="btn-ver-graficos" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded font-bold">📈 Ver Gráficos</button>
      </div><!-- Lista de Ventas -->
      <div class="bg-gray-50 p-4 rounded-lg">
       <h3 class="font-bold text-black mb-3">📋 Historial de Ventas</h3>
       <div id="lista-ventas-reportes" class="space-y-2 max-h-96 overflow-y-auto">
        <div class="text-center text-gray-500 py-8">
         No hay ventas registradas aún
        </div>
       </div>
      </div><!-- Modal de Gráficos -->
      <div id="modal-graficos" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
       <div class="bg-white p-6 rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-xl font-bold text-black">📈 Gráficos de Ventas</h3><button id="btn-cerrar-graficos" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">✕ Cerrar</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- Gráfico de Ventas por Método de Pago -->
         <div class="bg-gray-50 p-4 rounded">
          <h4 class="font-bold text-black mb-3">Ventas por Método de Pago</h4>
          <canvas id="grafico-metodos-pago" width="300" height="200"></canvas>
         </div><!-- Gráfico de Ventas por Categoría -->
         <div class="bg-gray-50 p-4 rounded">
          <h4 class="font-bold text-black mb-3">Ventas por Categoría</h4>
          <canvas id="grafico-categorias" width="300" height="200"></canvas>
         </div><!-- Gráfico de Ventas Diarias -->
         <div class="bg-gray-50 p-4 rounded md:col-span-2">
          <h4 class="font-bold text-black mb-3">Ventas por Día</h4>
          <canvas id="grafico-ventas-diarias" width="600" height="200"></canvas>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      titulo_principal: "Calculadora Mágica",
      texto_inventario: "Inventario",
      texto_ventas: "Ventas",
      background_color: "#f0fdf4",
      surface_color: "#ffffff",
      text_color: "#000000",
      primary_color: "#16a34a",
      secondary_color: "#15803d",
      font_family: "system-ui",
      font_size: 16
    };

    let tasaDolar = 0;
    let inventarioData = [];
    let ventaActual = [];
    let todosLosDatos = [];
    let ventasData = [];
    let ventasFiltradas = [];
    let isInitialized = false;
    
    // Variables para el escáner
    let codeReader = null;
    let videoStream = null;
    let isScanning = false;
    
    // Variables para escáner de ventas
    let codeReaderVenta = null;
    let isScanningVenta = false;
    let productoEscaneadoVenta = null;



    const dataHandler = {
      onDataChanged(data) {
        todosLosDatos = data;
        // Filtrar productos, ventas y configuración
        inventarioData = data.filter(item => item.tipo === 'producto');
        ventasData = data.filter(item => item.tipo === 'venta');
        const configData = data.filter(item => item.tipo === 'configuracion');
        
        // Cargar la tasa guardada
        if (configData.length > 0) {
          const config = configData[0];
          if (config.tasa_dolar && config.tasa_dolar > 0) {
            tasaDolar = config.tasa_dolar;
            document.getElementById('tasa-actual').textContent = `Tasa actual: BsF ${tasaDolar.toFixed(2)}`;
            document.getElementById('tasa-actual-calc').textContent = `Tasa actual: BsF ${tasaDolar.toFixed(2)}`;
            document.getElementById('tasa-dolar').value = tasaDolar;
            document.getElementById('tasa-dolar-calc').value = tasaDolar;
          }
        }
        
        actualizarListaInventario();
        actualizarSelectProductos();
        verificarLimiteInventario();
        actualizarReportes();
      }
    };

    async function onConfigChange(config) {
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'system-ui, -apple-system, sans-serif';
      const baseSize = config.font_size || defaultConfig.font_size;
      
      document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
      document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
      
      document.getElementById('titulo-principal').textContent = config.titulo_principal || defaultConfig.titulo_principal;
      document.getElementById('titulo-principal').style.fontSize = `${baseSize * 2}px`;
      document.getElementById('titulo-principal').style.color = config.text_color || defaultConfig.text_color;
      
      document.getElementById('texto-inventario').textContent = config.texto_inventario || defaultConfig.texto_inventario;
      document.getElementById('texto-inventario').style.fontSize = `${baseSize * 1.5}px`;
      document.getElementById('texto-inventario').style.color = config.text_color || defaultConfig.text_color;
      
      document.getElementById('texto-ventas').textContent = config.texto_ventas || defaultConfig.texto_ventas;
      document.getElementById('texto-ventas').style.fontSize = `${baseSize * 1.5}px`;
      document.getElementById('texto-ventas').style.color = config.text_color || defaultConfig.text_color;
      
      const buttons = document.querySelectorAll('button');
      buttons.forEach(btn => {
        if (!btn.classList.contains('bg-red-600') && !btn.classList.contains('bg-blue-600')) {
          btn.style.backgroundColor = config.primary_color || defaultConfig.primary_color;
        }
        btn.style.fontSize = `${baseSize}px`;
      });
      
      const surfaces = document.querySelectorAll('.bg-white');
      surfaces.forEach(surface => {
        surface.style.backgroundColor = config.surface_color || defaultConfig.surface_color;
      });
      
      const labels = document.querySelectorAll('label, h2, h3, span');
      labels.forEach(label => {
        label.style.color = config.text_color || defaultConfig.text_color;
        label.style.fontSize = `${baseSize}px`;
      });
    }

    async function init() {
      try {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error("Error al inicializar SDK");
          return;
        }
        
        if (window.elementSdk) {
          window.elementSdk.init({
            defaultConfig,
            onConfigChange,
            mapToCapabilities: (config) => ({
              recolorables: [
                {
                  get: () => config.background_color || defaultConfig.background_color,
                  set: (value) => {
                    config.background_color = value;
                    window.elementSdk.setConfig({ background_color: value });
                  }
                },
                {
                  get: () => config.surface_color || defaultConfig.surface_color,
                  set: (value) => {
                    config.surface_color = value;
                    window.elementSdk.setConfig({ surface_color: value });
                  }
                },
                {
                  get: () => config.text_color || defaultConfig.text_color,
                  set: (value) => {
                    config.text_color = value;
                    window.elementSdk.setConfig({ text_color: value });
                  }
                },
                {
                  get: () => config.primary_color || defaultConfig.primary_color,
                  set: (value) => {
                    config.primary_color = value;
                    window.elementSdk.setConfig({ primary_color: value });
                  }
                },
                {
                  get: () => config.secondary_color || defaultConfig.secondary_color,
                  set: (value) => {
                    config.secondary_color = value;
                    window.elementSdk.setConfig({ secondary_color: value });
                  }
                }
              ],
              borderables: [],
              fontEditable: {
                get: () => config.font_family || defaultConfig.font_family,
                set: (value) => {
                  config.font_family = value;
                  window.elementSdk.setConfig({ font_family: value });
                }
              },
              fontSizeable: {
                get: () => config.font_size || defaultConfig.font_size,
                set: (value) => {
                  config.font_size = value;
                  window.elementSdk.setConfig({ font_size: value });
                }
              }
            }),
            mapToEditPanelValues: (config) => new Map([
              ["titulo_principal", config.titulo_principal || defaultConfig.titulo_principal],
              ["texto_inventario", config.texto_inventario || defaultConfig.texto_inventario],
              ["texto_ventas", config.texto_ventas || defaultConfig.texto_ventas]
            ])
          });
        }
        
        isInitialized = true;
        setupMainEventListeners();
        
        // Aplicar configuración inicial
        await onConfigChange(defaultConfig);
        
      } catch (error) {
        console.error("Error en inicialización:", error);
        // Continuar sin SDK si hay error
        isInitialized = true;
        setupMainEventListeners();
        await onConfigChange(defaultConfig);
      }
    }

    function setupMainEventListeners() {
      // Pestañas principales
      document.getElementById('tab-calculadora').addEventListener('click', () => mostrarPestana('calculadora'));
      document.getElementById('tab-inventario').addEventListener('click', () => mostrarPestana('inventario'));
      document.getElementById('tab-ventas').addEventListener('click', () => mostrarPestana('ventas'));
      document.getElementById('tab-reportes').addEventListener('click', () => mostrarPestana('reportes'));
      
      // Pestañas de venta
      document.getElementById('tab-venta-inventario').addEventListener('click', () => mostrarTipoVenta('inventario'));
      document.getElementById('tab-venta-manual').addEventListener('click', () => mostrarTipoVenta('manual'));
      
      // Pestañas de inventario
      document.getElementById('tab-escaner').addEventListener('click', () => mostrarMetodoInventario('escaner'));
      document.getElementById('tab-manual').addEventListener('click', () => mostrarMetodoInventario('manual'));
      
      // Escáner de códigos
      document.getElementById('btn-iniciar-camara').addEventListener('click', iniciarEscaner);
      document.getElementById('btn-detener-camara').addEventListener('click', detenerEscaner);
      document.getElementById('btn-usar-codigo').addEventListener('click', usarCodigoEscaneado);
      document.getElementById('btn-escanear-otro').addEventListener('click', escanearOtroCodigo);
      
      // Escáner para ventas
      document.getElementById('btn-escaner-venta').addEventListener('click', iniciarEscanerVenta);
      document.getElementById('btn-detener-escaner-venta').addEventListener('click', detenerEscanerVenta);
      document.getElementById('btn-agregar-escaneado').addEventListener('click', agregarProductoEscaneado);
      document.getElementById('btn-continuar-escaneando').addEventListener('click', continuarEscaneandoVenta);
      
      // Funcionalidades existentes
      document.getElementById('btn-actualizar-tasa').addEventListener('click', actualizarTasa);
      document.getElementById('btn-actualizar-tasa-calc').addEventListener('click', actualizarTasaCalc);
      document.getElementById('btn-agregar-producto').addEventListener('click', agregarProducto);
      document.getElementById('btn-agregar-venta').addEventListener('click', agregarItemVenta);
      document.getElementById('btn-agregar-venta-manual').addEventListener('click', agregarVentaManual);
      document.getElementById('btn-finalizar-venta').addEventListener('click', finalizarVenta);
      document.getElementById('btn-eliminar-venta').addEventListener('click', eliminarVentaCompleta);
      
      // Calculadoras de precio
      document.getElementById('inv-precio-dolar').addEventListener('input', calcularPrecioBolivar);
      document.getElementById('inv-precio-bolivar').addEventListener('input', calcularPrecioDolar);
      
      // Calculadoras de precio para venta manual
      document.getElementById('manual-precio-dolar').addEventListener('input', calcularPrecioBolivarManual);
      document.getElementById('manual-precio-bolivar').addEventListener('input', calcularPrecioDolarManual);
      
      // Convertidores de moneda
      document.getElementById('conv-dolares').addEventListener('input', convertirDolaresABolivares);
      document.getElementById('conv-bolivares').addEventListener('input', convertirBolivaresADolares);
      
      // Búsqueda de productos
      document.getElementById('buscar-producto').addEventListener('input', filtrarProductos);
      
      // Búsqueda por código de barras en el campo de búsqueda
      document.getElementById('buscar-producto').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          buscarProductoPorCodigoEnCampo();
        }
      });
      
      // Reportes
      document.getElementById('btn-aplicar-filtros').addEventListener('click', aplicarFiltrosReportes);
      document.getElementById('btn-limpiar-filtros').addEventListener('click', limpiarFiltrosReportes);
      document.getElementById('btn-exportar-excel').addEventListener('click', exportarReportesExcel);
      document.getElementById('btn-exportar-pdf').addEventListener('click', exportarReportesPDF);
      document.getElementById('btn-ver-graficos').addEventListener('click', mostrarGraficos);
      document.getElementById('btn-cerrar-graficos').addEventListener('click', cerrarGraficos);
    }





    function mostrarPestana(pestana) {
      // Ocultar todas las pestañas
      document.querySelectorAll('.pestana-contenido').forEach(p => p.classList.add('hidden'));
      
      // Resetear estilos de botones
      document.querySelectorAll('[id^="tab-calculadora"], [id^="tab-inventario"], [id^="tab-ventas"]').forEach(btn => {
        btn.className = 'flex-1 py-3 px-4 rounded-md font-semibold text-black hover:bg-green-200';
      });
      
      // Mostrar pestaña seleccionada
      document.getElementById(`pestana-${pestana}`).classList.remove('hidden');
      document.getElementById(`tab-${pestana}`).className = 'flex-1 py-3 px-4 rounded-md font-semibold text-black bg-white border-2 border-green-600';
    }

    async function actualizarTasa() {
      const input = document.getElementById('tasa-dolar');
      const valor = parseFloat(input.value);
      
      if (valor > 0) {
        tasaDolar = valor;
        document.getElementById('tasa-actual').textContent = `Tasa actual: BsF ${tasaDolar.toFixed(2)}`;
        document.getElementById('tasa-actual-calc').textContent = `Tasa actual: BsF ${tasaDolar.toFixed(2)}`;
        document.getElementById('tasa-dolar-calc').value = valor;
        
        // Guardar la tasa en la base de datos
        await guardarTasaDolar(valor);
      }
    }

    async function actualizarTasaCalc() {
      const input = document.getElementById('tasa-dolar-calc');
      const valor = parseFloat(input.value);
      
      if (valor > 0) {
        tasaDolar = valor;
        document.getElementById('tasa-actual').textContent = `Tasa actual: BsF ${tasaDolar.toFixed(2)}`;
        document.getElementById('tasa-actual-calc').textContent = `Tasa actual: BsF ${tasaDolar.toFixed(2)}`;
        document.getElementById('tasa-dolar').value = valor;
        
        // Guardar la tasa en la base de datos
        await guardarTasaDolar(valor);
      }
    }

    function convertirDolaresABolivares() {
      if (tasaDolar === 0) return;
      const dolares = parseFloat(document.getElementById('conv-dolares').value) || 0;
      const bolivares = dolares * tasaDolar;
      document.getElementById('resultado-bolivares').textContent = `BsF ${bolivares.toFixed(2)}`;
    }

    function convertirBolivaresADolares() {
      if (tasaDolar === 0) return;
      const bolivares = parseFloat(document.getElementById('conv-bolivares').value) || 0;
      const dolares = bolivares / tasaDolar;
      document.getElementById('resultado-dolares').textContent = `$ ${dolares.toFixed(2)}`;
    }

    function calcularPrecioBolivar() {
      if (tasaDolar === 0) return;
      const precioDolar = parseFloat(document.getElementById('inv-precio-dolar').value) || 0;
      document.getElementById('inv-precio-bolivar').value = (precioDolar * tasaDolar).toFixed(2);
    }

    function calcularPrecioDolar() {
      if (tasaDolar === 0) return;
      const precioBolivar = parseFloat(document.getElementById('inv-precio-bolivar').value) || 0;
      document.getElementById('inv-precio-dolar').value = (precioBolivar / tasaDolar).toFixed(2);
    }

    function mostrarTipoVenta(tipo) {
      // Detener escáner de ventas si está activo
      if (isScanningVenta) {
        detenerEscanerVenta();
      }
      
      // Ocultar ambos formularios
      document.getElementById('venta-inventario').classList.add('hidden');
      document.getElementById('venta-manual-form').classList.add('hidden');
      
      // Resetear estilos de botones
      document.getElementById('tab-venta-inventario').className = 'flex-1 py-2 px-4 rounded-md font-semibold text-black hover:bg-gray-200';
      document.getElementById('tab-venta-manual').className = 'flex-1 py-2 px-4 rounded-md font-semibold text-black hover:bg-gray-200';
      
      // Mostrar formulario seleccionado
      if (tipo === 'inventario') {
        document.getElementById('venta-inventario').classList.remove('hidden');
        document.getElementById('tab-venta-inventario').className = 'flex-1 py-2 px-4 rounded-md font-semibold text-black bg-white border-2 border-green-600';
      } else {
        document.getElementById('venta-manual-form').classList.remove('hidden');
        document.getElementById('tab-venta-manual').className = 'flex-1 py-2 px-4 rounded-md font-semibold text-black bg-white border-2 border-blue-600';
      }
    }

    function mostrarMetodoInventario(metodo) {
      // Detener escáner si está activo
      if (isScanning) {
        detenerEscaner();
      }
      
      // Ocultar ambos formularios
      document.getElementById('inv-escaner').classList.add('hidden');
      document.getElementById('inv-manual').classList.add('hidden');
      
      // Resetear estilos de botones
      document.getElementById('tab-escaner').className = 'flex-1 py-2 px-4 rounded-md font-semibold text-black hover:bg-gray-200';
      document.getElementById('tab-manual').className = 'flex-1 py-2 px-4 rounded-md font-semibold text-black hover:bg-gray-200';
      
      // Mostrar formulario seleccionado
      if (metodo === 'escaner') {
        document.getElementById('inv-escaner').classList.remove('hidden');
        document.getElementById('tab-escaner').className = 'flex-1 py-2 px-4 rounded-md font-semibold text-black bg-white border-2 border-blue-600';
      } else {
        document.getElementById('inv-manual').classList.remove('hidden');
        document.getElementById('tab-manual').className = 'flex-1 py-2 px-4 rounded-md font-semibold text-black bg-white border-2 border-green-600';
      }
    }

    async function iniciarEscaner() {
      try {
        // Ocultar errores previos
        document.getElementById('error-escaner').classList.add('hidden');
        document.getElementById('resultado-escaner').classList.add('hidden');
        
        // Verificar si ZXing está disponible
        if (typeof ZXing === 'undefined') {
          mostrarErrorEscaner('Librería de escáner no disponible. Recarga la página.');
          return;
        }
        
        // Inicializar el lector de códigos
        codeReader = new ZXing.BrowserMultiFormatReader();
        
        // Obtener dispositivos de video
        const videoInputDevices = await codeReader.listVideoInputDevices();
        
        if (videoInputDevices.length === 0) {
          mostrarErrorEscaner('No se encontraron cámaras disponibles.');
          return;
        }
        
        // Usar la cámara trasera si está disponible, sino la primera disponible
        const selectedDeviceId = videoInputDevices.find(device => 
          device.label.toLowerCase().includes('back') || 
          device.label.toLowerCase().includes('rear')
        )?.deviceId || videoInputDevices[0].deviceId;
        
        // Mostrar controles
        document.getElementById('btn-iniciar-camara').classList.add('hidden');
        document.getElementById('btn-detener-camara').classList.remove('hidden');
        document.getElementById('camara-container').classList.remove('hidden');
        
        isScanning = true;
        
        // Iniciar el escáner
        const video = document.getElementById('video-camara');
        
        codeReader.decodeFromVideoDevice(selectedDeviceId, video, (result, err) => {
          if (result) {
            // Código detectado
            const codigo = result.getText();
            document.getElementById('codigo-detectado').textContent = codigo;
            document.getElementById('resultado-escaner').classList.remove('hidden');
            
            // Pausar el escáner temporalmente
            pausarEscaner();
          }
          
          if (err && !(err instanceof ZXing.NotFoundException)) {
            console.log('Error de escáner:', err);
          }
        });
        
      } catch (error) {
        console.error('Error al iniciar escáner:', error);
        mostrarErrorEscaner('Error al acceder a la cámara. Verifica los permisos.');
        detenerEscaner();
      }
    }

    function pausarEscaner() {
      if (codeReader) {
        codeReader.reset();
      }
      isScanning = false;
    }

    function detenerEscaner() {
      if (codeReader) {
        codeReader.reset();
        codeReader = null;
      }
      
      isScanning = false;
      
      // Ocultar controles
      document.getElementById('btn-iniciar-camara').classList.remove('hidden');
      document.getElementById('btn-detener-camara').classList.add('hidden');
      document.getElementById('camara-container').classList.add('hidden');
      document.getElementById('resultado-escaner').classList.add('hidden');
      document.getElementById('error-escaner').classList.add('hidden');
    }

    function mostrarErrorEscaner(mensaje) {
      document.getElementById('mensaje-error').textContent = mensaje;
      document.getElementById('error-escaner').classList.remove('hidden');
    }

    function usarCodigoEscaneado() {
      const codigo = document.getElementById('codigo-detectado').textContent;
      
      // Cambiar a modo manual y llenar el código
      mostrarMetodoInventario('manual');
      document.getElementById('inv-codigo-barras').value = codigo;
      
      // Enfocar en el campo de nombre
      document.getElementById('inv-nombre').focus();
      
      // Detener el escáner
      detenerEscaner();
    }

    function escanearOtroCodigo() {
      document.getElementById('resultado-escaner').classList.add('hidden');
      iniciarEscaner();
    }

    // Funciones del escáner para ventas
    async function iniciarEscanerVenta() {
      try {
        // Ocultar errores previos
        document.getElementById('error-venta-escaner').classList.add('hidden');
        document.getElementById('resultado-venta-escaner').classList.add('hidden');
        
        // Verificar si ZXing está disponible
        if (typeof ZXing === 'undefined') {
          mostrarErrorEscanerVenta('Librería de escáner no disponible. Recarga la página.');
          return;
        }
        
        // Inicializar el lector de códigos
        codeReaderVenta = new ZXing.BrowserMultiFormatReader();
        
        // Obtener dispositivos de video
        const videoInputDevices = await codeReaderVenta.listVideoInputDevices();
        
        if (videoInputDevices.length === 0) {
          mostrarErrorEscanerVenta('No se encontraron cámaras disponibles.');
          return;
        }
        
        // Usar la cámara trasera si está disponible
        const selectedDeviceId = videoInputDevices.find(device => 
          device.label.toLowerCase().includes('back') || 
          device.label.toLowerCase().includes('rear')
        )?.deviceId || videoInputDevices[0].deviceId;
        
        // Mostrar controles
        document.getElementById('btn-escaner-venta').classList.add('hidden');
        document.getElementById('btn-detener-escaner-venta').classList.remove('hidden');
        document.getElementById('camara-venta-container').classList.remove('hidden');
        
        isScanningVenta = true;
        
        // Iniciar el escáner
        const video = document.getElementById('video-venta');
        
        codeReaderVenta.decodeFromVideoDevice(selectedDeviceId, video, (result, err) => {
          if (result) {
            // Código detectado
            const codigo = result.getText();
            buscarProductoPorCodigo(codigo);
            
            // Pausar el escáner temporalmente
            pausarEscanerVenta();
          }
          
          if (err && !(err instanceof ZXing.NotFoundException)) {
            console.log('Error de escáner ventas:', err);
          }
        });
        
      } catch (error) {
        console.error('Error al iniciar escáner ventas:', error);
        mostrarErrorEscanerVenta('Error al acceder a la cámara. Verifica los permisos.');
        detenerEscanerVenta();
      }
    }

    function pausarEscanerVenta() {
      if (codeReaderVenta) {
        codeReaderVenta.reset();
      }
      isScanningVenta = false;
    }

    function detenerEscanerVenta() {
      if (codeReaderVenta) {
        codeReaderVenta.reset();
        codeReaderVenta = null;
      }
      
      isScanningVenta = false;
      productoEscaneadoVenta = null;
      
      // Ocultar controles
      document.getElementById('btn-escaner-venta').classList.remove('hidden');
      document.getElementById('btn-detener-escaner-venta').classList.add('hidden');
      document.getElementById('camara-venta-container').classList.add('hidden');
      document.getElementById('resultado-venta-escaner').classList.add('hidden');
      document.getElementById('error-venta-escaner').classList.add('hidden');
    }

    function mostrarErrorEscanerVenta(mensaje) {
      document.getElementById('mensaje-error-venta').textContent = mensaje;
      document.getElementById('error-venta-escaner').classList.remove('hidden');
    }

    function buscarProductoPorCodigo(codigo) {
      // Buscar producto en inventario por código de barras
      const producto = inventarioData.find(p => 
        p.codigo_barras && p.codigo_barras.trim() === codigo.trim() && p.cantidad > 0
      );
      
      if (producto) {
        // Producto encontrado
        productoEscaneadoVenta = producto;
        const info = `
          <div class="font-bold">${producto.nombre}</div>
          <div class="text-sm">Código: ${codigo}</div>
          <div class="text-sm">Precio: $${producto.precio_dolar.toFixed(2)} / BsF ${producto.precio_bolivar.toFixed(2)}</div>
          <div class="text-sm">Disponible: ${producto.cantidad} ${producto.unidad || 'unidades'}</div>
          <div class="text-sm">Categoría: ${producto.categoria || 'Sin categoría'}</div>
        `;
        document.getElementById('producto-encontrado-info').innerHTML = info;
        document.getElementById('resultado-venta-escaner').classList.remove('hidden');
      } else {
        // Producto no encontrado
        mostrarErrorEscanerVenta(`Producto con código "${codigo}" no encontrado en inventario o sin stock.`);
      }
    }

    function agregarProductoEscaneado() {
      if (!productoEscaneadoVenta) return;
      
      // Agregar producto a la venta con cantidad 1 y modo de pago por defecto
      ventaActual.push({
        producto: productoEscaneadoVenta,
        cantidad: 1,
        modoPago: 'pago movil',
        tipo: 'inventario'
      });
      
      actualizarListaVenta();
      
      // Limpiar y cerrar escáner
      productoEscaneadoVenta = null;
      document.getElementById('resultado-venta-escaner').classList.add('hidden');
      
      // Mostrar mensaje de éxito
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
          <h3 class="text-lg font-bold mb-4 text-green-600">✅ Producto Agregado</h3>
          <p class="mb-4">El producto ha sido agregado a la venta exitosamente.</p>
          <div class="flex justify-center">
            <button id="btn-cerrar-agregado" class="bg-green-600 text-white px-6 py-2 rounded">Continuar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('btn-cerrar-agregado').onclick = () => {
        document.body.removeChild(modal);
      };
      
      // Auto-cerrar después de 2 segundos
      setTimeout(() => {
        if (document.body.contains(modal)) {
          document.body.removeChild(modal);
        }
      }, 2000);
    }

    function continuarEscaneandoVenta() {
      document.getElementById('resultado-venta-escaner').classList.add('hidden');
      productoEscaneadoVenta = null;
      iniciarEscanerVenta();
    }

    function buscarProductoPorCodigoEnCampo() {
      const codigo = document.getElementById('buscar-producto').value.trim();
      
      if (!codigo) return;
      
      // Buscar producto por código de barras
      const producto = inventarioData.find(p => 
        p.codigo_barras && p.codigo_barras.trim() === codigo && p.cantidad > 0
      );
      
      if (producto) {
        // Seleccionar automáticamente el producto
        document.getElementById('venta-producto').value = producto.__backendId;
        document.getElementById('venta-cantidad').value = '1';
        document.getElementById('venta-cantidad').focus();
        
        // Mostrar mensaje de éxito
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4 text-green-600">✅ Producto Encontrado</h3>
            <p class="mb-2"><strong>${producto.nombre}</strong></p>
            <p class="mb-2 text-sm">Código: ${codigo}</p>
            <p class="mb-4 text-sm">Disponible: ${producto.cantidad} ${producto.unidad || 'unidades'}</p>
            <div class="flex justify-center">
              <button id="btn-cerrar-encontrado" class="bg-green-600 text-white px-6 py-2 rounded">Continuar</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('btn-cerrar-encontrado').onclick = () => {
          document.body.removeChild(modal);
        };
        
        // Auto-cerrar después de 2 segundos
        setTimeout(() => {
          if (document.body.contains(modal)) {
            document.body.removeChild(modal);
          }
        }, 2000);
        
      } else {
        // Producto no encontrado
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4 text-red-600">❌ Producto No Encontrado</h3>
            <p class="mb-4">No se encontró ningún producto con el código "${codigo}" o está sin stock.</p>
            <div class="flex justify-center">
              <button id="btn-cerrar-no-encontrado" class="bg-red-600 text-white px-6 py-2 rounded">Entendido</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('btn-cerrar-no-encontrado').onclick = () => {
          document.body.removeChild(modal);
        };
      }
    }

    function calcularPrecioBolivarManual() {
      if (tasaDolar === 0) return;
      const precioDolar = parseFloat(document.getElementById('manual-precio-dolar').value) || 0;
      document.getElementById('manual-precio-bolivar').value = (precioDolar * tasaDolar).toFixed(2);
    }

    function calcularPrecioDolarManual() {
      if (tasaDolar === 0) return;
      const precioBolivar = parseFloat(document.getElementById('manual-precio-bolivar').value) || 0;
      document.getElementById('manual-precio-dolar').value = (precioBolivar / tasaDolar).toFixed(2);
    }

    function verificarLimiteInventario() {
      const limiteDiv = document.getElementById('limite-inventario');
      if (inventarioData.length >= 999) {
        limiteDiv.classList.remove('hidden');
      } else {
        limiteDiv.classList.add('hidden');
      }
    }

    async function agregarProducto() {
      if (inventarioData.length >= 999) {
        mostrarMensaje('❌ Límite Alcanzado', 'Has alcanzado el límite máximo de 999 productos. Elimina algunos productos primero.', 'error');
        return;
      }

      const nombre = document.getElementById('inv-nombre').value.trim();
      const categoria = document.getElementById('inv-categoria').value;
      const precioDolar = parseFloat(document.getElementById('inv-precio-dolar').value) || 0;
      const precioBolivar = parseFloat(document.getElementById('inv-precio-bolivar').value) || 0;
      const cantidad = parseInt(document.getElementById('inv-cantidad').value) || 0;
      const unidad = document.getElementById('inv-unidad').value;
      
      if (!nombre) {
        mostrarMensaje('❌ Campo Requerido', 'El nombre del producto es obligatorio.', 'error');
        return;
      }
      
      if (precioDolar === 0 && precioBolivar === 0) {
        mostrarMensaje('❌ Precio Requerido', 'Debes ingresar al menos un precio (en dólares o bolívares).', 'error');
        return;
      }
      
      const btn = document.getElementById('btn-agregar-producto');
      const textoOriginal = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Agregando...';
      
      try {
        const codigoBarras = document.getElementById('inv-codigo-barras').value.trim();
        
        const producto = {
          id: Date.now().toString(),
          codigo_barras: codigoBarras,
          nombre: nombre,
          categoria: categoria,
          precio_dolar: precioDolar,
          precio_bolivar: precioBolivar,
          cantidad: cantidad,
          unidad: unidad,
          tipo: 'producto'
        };
        
        const result = await window.dataSdk.create(producto);
        
        if (result.isOk) {
          // Limpiar formulario
          document.getElementById('inv-codigo-barras').value = '';
          document.getElementById('inv-nombre').value = '';
          document.getElementById('inv-categoria').value = 'abarrotes';
          document.getElementById('inv-precio-dolar').value = '';
          document.getElementById('inv-precio-bolivar').value = '';
          document.getElementById('inv-cantidad').value = '';
          document.getElementById('inv-unidad').value = 'unidades';
          
          mostrarMensaje('✅ Producto Agregado', `"${nombre}" ha sido agregado al inventario exitosamente.`, 'success');
        } else {
          mostrarMensaje('❌ Error al Guardar', 'No se pudo agregar el producto. Inténtalo de nuevo.', 'error');
        }
      } catch (error) {
        console.error('Error al agregar producto:', error);
        mostrarMensaje('❌ Error Inesperado', 'Ocurrió un error al agregar el producto. Inténtalo de nuevo.', 'error');
      }
      
      // Siempre restaurar el botón después de un pequeño delay
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = textoOriginal;
      }, 100);
    }

    function actualizarListaInventario() {
      const lista = document.getElementById('lista-inventario');
      lista.innerHTML = '';
      
      // Ordenar productos alfabéticamente (insensible a mayúsculas/minúsculas)
      const productosOrdenados = [...inventarioData].sort((a, b) => 
        a.nombre.toLowerCase().localeCompare(b.nombre.toLowerCase())
      );
      
      productosOrdenados.forEach(producto => {
        const div = document.createElement('div');
        div.className = 'bg-green-50 p-3 rounded border border-green-300';
        div.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="font-bold text-black">${producto.nombre}</div>
              ${producto.codigo_barras ? `<div class="text-xs text-black bg-blue-200 inline-block px-2 py-1 rounded mb-1 font-mono">📱 ${producto.codigo_barras}</div>` : ''}
              <div class="text-xs text-black bg-green-200 inline-block px-2 py-1 rounded mb-1">${producto.categoria || 'Sin categoría'}</div>
              <div class="text-sm text-black">Precio: $${producto.precio_dolar.toFixed(2)} / BsF ${producto.precio_bolivar.toFixed(2)}</div>
              <div class="text-sm text-black">Cantidad: ${producto.cantidad} ${producto.unidad || 'unidades'}</div>
            </div>
            <div class="flex gap-2">
              <button onclick="editarProducto('${producto.__backendId}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">Editar</button>
              <button onclick="eliminarProducto('${producto.__backendId}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">Eliminar</button>
            </div>
          </div>
        `;
        lista.appendChild(div);
      });
    }

    function actualizarSelectProductos(filtro = '') {
      const select = document.getElementById('venta-producto');
      select.innerHTML = '<option value="">-- Seleccionar --</option>';
      
      // Filtrar y ordenar productos alfabéticamente
      let productosDisponibles = inventarioData.filter(p => p.cantidad > 0);
      
      if (filtro) {
        productosDisponibles = productosDisponibles.filter(p => 
          p.nombre.toLowerCase().includes(filtro.toLowerCase())
        );
      }
      
      productosDisponibles.sort((a, b) => a.nombre.localeCompare(b.nombre));
      
      productosDisponibles.forEach(producto => {
        const option = document.createElement('option');
        option.value = producto.__backendId;
        option.textContent = `${producto.nombre} (${producto.cantidad} ${producto.unidad || 'unidades'} disponibles) - ${producto.categoria}`;
        select.appendChild(option);
      });
    }

    function filtrarProductos() {
      const filtro = document.getElementById('buscar-producto').value;
      actualizarSelectProductos(filtro);
    }

    async function editarProducto(backendId) {
      const producto = inventarioData.find(p => p.__backendId === backendId);
      if (!producto) return;
      
      // Crear modal personalizado
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
          <h3 class="text-lg font-bold mb-4">Editar Producto</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-semibold mb-1">Nombre:</label>
              <input type="text" id="edit-nombre" value="${producto.nombre}" class="w-full border rounded px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Precio ($):</label>
              <input type="number" id="edit-precio" value="${producto.precio_dolar}" step="0.01" class="w-full border rounded px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Cantidad:</label>
              <input type="number" id="edit-cantidad" value="${producto.cantidad}" class="w-full border rounded px-3 py-2">
            </div>
            <div class="flex gap-2 mt-4">
              <button id="btn-guardar-edit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded">Guardar</button>
              <button id="btn-cancelar-edit" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('btn-cancelar-edit').onclick = () => {
        document.body.removeChild(modal);
      };
      
      document.getElementById('btn-guardar-edit').onclick = async () => {
        const nuevoNombre = document.getElementById('edit-nombre').value.trim();
        const nuevoPrecio = parseFloat(document.getElementById('edit-precio').value);
        const nuevaCantidad = parseInt(document.getElementById('edit-cantidad').value);
        
        if (nuevoNombre && !isNaN(nuevoPrecio) && !isNaN(nuevaCantidad)) {
          const productoActualizado = {
            ...producto,
            nombre: nuevoNombre,
            precio_dolar: nuevoPrecio,
            precio_bolivar: tasaDolar > 0 ? nuevoPrecio * tasaDolar : producto.precio_bolivar,
            cantidad: nuevaCantidad
          };
          
          await window.dataSdk.update(productoActualizado);
          document.body.removeChild(modal);
        }
      };
    }

    async function eliminarProducto(backendId) {
      const producto = inventarioData.find(p => p.__backendId === backendId);
      if (!producto) return;
      
      // Crear confirmación personalizada
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
          <h3 class="text-lg font-bold mb-4">Confirmar Eliminación</h3>
          <p class="mb-4">¿Estás seguro de eliminar "${producto.nombre}"?</p>
          <div class="flex gap-2">
            <button id="btn-confirmar-delete" class="flex-1 bg-red-600 text-white px-4 py-2 rounded">Eliminar</button>
            <button id="btn-cancelar-delete" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('btn-cancelar-delete').onclick = () => {
        document.body.removeChild(modal);
      };
      
      document.getElementById('btn-confirmar-delete').onclick = async () => {
        await window.dataSdk.delete(producto);
        document.body.removeChild(modal);
      };
    }

    function agregarItemVenta() {
      const selectProducto = document.getElementById('venta-producto');
      const backendId = selectProducto.value;
      const cantidad = parseInt(document.getElementById('venta-cantidad').value) || 1;
      const modoPago = document.getElementById('venta-pago').value;
      
      if (!backendId) return;
      
      const producto = inventarioData.find(p => p.__backendId === backendId);
      if (!producto || producto.cantidad < cantidad) return;
      
      ventaActual.push({
        producto: producto,
        cantidad: cantidad,
        modoPago: modoPago,
        tipo: 'inventario'
      });
      
      actualizarListaVenta();
      selectProducto.value = '';
      document.getElementById('venta-cantidad').value = '1';
      document.getElementById('buscar-producto').value = '';
      actualizarSelectProductos();
    }

    function agregarVentaManual() {
      const nombre = document.getElementById('manual-nombre').value.trim();
      const categoria = document.getElementById('manual-categoria').value;
      const precioDolar = parseFloat(document.getElementById('manual-precio-dolar').value) || 0;
      const precioBolivar = parseFloat(document.getElementById('manual-precio-bolivar').value) || 0;
      const cantidad = parseInt(document.getElementById('manual-cantidad').value) || 1;
      const modoPago = document.getElementById('manual-pago').value;
      
      if (!nombre || (precioDolar === 0 && precioBolivar === 0)) {
        return;
      }
      
      // Crear producto temporal para la venta
      const productoManual = {
        nombre: nombre,
        categoria: categoria,
        precio_dolar: precioDolar,
        precio_bolivar: precioBolivar
      };
      
      ventaActual.push({
        producto: productoManual,
        cantidad: cantidad,
        modoPago: modoPago,
        tipo: 'manual'
      });
      
      actualizarListaVenta();
      
      // Limpiar formulario
      document.getElementById('manual-nombre').value = '';
      document.getElementById('manual-categoria').value = 'abarrotes';
      document.getElementById('manual-precio-dolar').value = '';
      document.getElementById('manual-precio-bolivar').value = '';
      document.getElementById('manual-cantidad').value = '1';
      document.getElementById('manual-pago').value = 'pago movil';
    }

    function actualizarListaVenta() {
      const lista = document.getElementById('items-venta');
      lista.innerHTML = '';
      
      let totalDolares = 0;
      let totalBolivares = 0;
      
      ventaActual.forEach((item, index) => {
        const subtotalDolar = item.producto.precio_dolar * item.cantidad;
        const subtotalBolivar = item.producto.precio_bolivar * item.cantidad;
        
        totalDolares += subtotalDolar;
        totalBolivares += subtotalBolivar;
        
        const tipoVenta = item.tipo === 'manual' ? 'Manual' : 'Inventario';
        const colorFondo = item.tipo === 'manual' ? 'bg-blue-50 border-blue-300' : 'bg-green-50 border-green-300';
        
        const div = document.createElement('div');
        div.className = `${colorFondo} p-2 rounded border text-sm`;
        div.innerHTML = `
          <div class="flex justify-between items-center">
            <div class="flex-1">
              <div class="font-bold text-black">${item.producto.nombre} x${item.cantidad}</div>
              <div class="text-black">$${subtotalDolar.toFixed(2)} / BsF ${subtotalBolivar.toFixed(2)}</div>
              <div class="text-black text-xs">${item.modoPago} - ${item.producto.categoria} - ${tipoVenta}</div>
            </div>
            <button onclick="eliminarItemVenta(${index})" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">X</button>
          </div>
        `;
        lista.appendChild(div);
      });
      
      document.getElementById('total-dolares').textContent = `$${totalDolares.toFixed(2)}`;
      document.getElementById('total-bolivares').textContent = `BsF ${totalBolivares.toFixed(2)}`;
    }

    function eliminarItemVenta(index) {
      ventaActual.splice(index, 1);
      actualizarListaVenta();
    }

    function eliminarVentaCompleta() {
      if (ventaActual.length === 0) {
        // Crear mensaje personalizado
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Sin Ventas</h3>
            <p class="mb-4">No hay productos en la venta actual para eliminar.</p>
            <div class="flex justify-center">
              <button id="btn-cerrar-mensaje" class="bg-blue-600 text-white px-6 py-2 rounded">Entendido</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('btn-cerrar-mensaje').onclick = () => {
          document.body.removeChild(modal);
        };
        return;
      }
      
      // Crear confirmación personalizada
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
          <h3 class="text-lg font-bold mb-4">Confirmar Eliminación de Venta</h3>
          <p class="mb-4">¿Estás seguro de eliminar toda la venta actual?</p>
          <p class="mb-4 text-sm text-gray-600">Se eliminarán ${ventaActual.length} producto(s) de la venta.</p>
          <div class="flex gap-2">
            <button id="btn-confirmar-eliminar-venta" class="flex-1 bg-red-600 text-white px-4 py-2 rounded">Eliminar Venta</button>
            <button id="btn-cancelar-eliminar-venta" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('btn-cancelar-eliminar-venta').onclick = () => {
        document.body.removeChild(modal);
      };
      
      document.getElementById('btn-confirmar-eliminar-venta').onclick = () => {
        ventaActual = [];
        actualizarListaVenta();
        document.body.removeChild(modal);
        
        // Mostrar mensaje de confirmación
        const confirmModal = document.createElement('div');
        confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        confirmModal.innerHTML = `
          <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4 text-green-600">✅ Venta Eliminada</h3>
            <p class="mb-4">La venta ha sido eliminada exitosamente.</p>
            <div class="flex justify-center">
              <button id="btn-cerrar-confirm" class="bg-green-600 text-white px-6 py-2 rounded">Continuar</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(confirmModal);
        
        document.getElementById('btn-cerrar-confirm').onclick = () => {
          document.body.removeChild(confirmModal);
        };
        
        // Auto-cerrar después de 2 segundos
        setTimeout(() => {
          if (document.body.contains(confirmModal)) {
            document.body.removeChild(confirmModal);
          }
        }, 2000);
      };
    }

    async function finalizarVenta() {
      if (ventaActual.length === 0) return;
      
      const btn = document.getElementById('btn-finalizar-venta');
      btn.disabled = true;
      btn.textContent = 'Procesando...';
      
      // Calcular totales
      let totalDolares = 0;
      let totalBolivares = 0;
      let productosVendidosTexto = [];
      
      // Solo actualizar inventario para productos del inventario
      for (const item of ventaActual) {
        const subtotalDolar = item.producto.precio_dolar * item.cantidad;
        const subtotalBolivar = item.producto.precio_bolivar * item.cantidad;
        
        totalDolares += subtotalDolar;
        totalBolivares += subtotalBolivar;
        productosVendidosTexto.push(`${item.producto.nombre} x${item.cantidad}`);
        
        if (item.tipo === 'inventario') {
          const productoActualizado = {
            ...item.producto,
            cantidad: item.producto.cantidad - item.cantidad
          };
          await window.dataSdk.update(productoActualizado);
        }
      }
      
      // Guardar la venta en la base de datos
      const venta = {
        id: Date.now().toString(),
        fecha_venta: new Date().toISOString(),
        modo_pago: ventaActual.map(item => item.modoPago).join(', '),
        total_dolar: totalDolares,
        total_bolivar: totalBolivares,
        productos_vendidos: productosVendidosTexto.join('; '),
        categoria: ventaActual.map(item => item.producto.categoria || 'Sin categoría').join(', '),
        tipo: 'venta'
      };
      
      await window.dataSdk.create(venta);
      
      generarExcel();
      ventaActual = [];
      actualizarListaVenta();
      
      btn.disabled = false;
      btn.textContent = 'Finalizar Venta';
      
      // Mostrar mensaje de éxito
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
          <h3 class="text-lg font-bold mb-4 text-green-600">✅ Venta Finalizada</h3>
          <p class="mb-4">La venta ha sido registrada exitosamente.</p>
          <p class="mb-4 text-sm text-gray-600">Total: $${totalDolares.toFixed(2)} / BsF ${totalBolivares.toFixed(2)}</p>
          <div class="flex justify-center">
            <button id="btn-cerrar-exito" class="bg-green-600 text-white px-6 py-2 rounded">Continuar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('btn-cerrar-exito').onclick = () => {
        document.body.removeChild(modal);
      };
      
      // Auto-cerrar después de 3 segundos
      setTimeout(() => {
        if (document.body.contains(modal)) {
          document.body.removeChild(modal);
        }
      }, 3000);
    }

    function generarExcel() {
      const fecha = new Date().toLocaleDateString('es-VE');
      let csv = 'Fecha,Producto,Categoria,Cantidad,Monto $,Monto BsF,Modo de Pago,Tipo de Venta\n';
      
      ventaActual.forEach(item => {
        const montoDolar = (item.producto.precio_dolar * item.cantidad).toFixed(2);
        const montoBolivar = (item.producto.precio_bolivar * item.cantidad).toFixed(2);
        const tipoVenta = item.tipo === 'manual' ? 'Manual' : 'Inventario';
        csv += `${fecha},${item.producto.nombre},${item.producto.categoria || 'Sin categoría'},${item.cantidad},${montoDolar},${montoBolivar},${item.modoPago},${tipoVenta}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `venta_${Date.now()}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Funciones de Reportes
    function actualizarReportes() {
      ventasFiltradas = [...ventasData];
      calcularEstadisticasReportes();
      actualizarListaVentasReportes();
    }

    function aplicarFiltrosReportes() {
      const fechaDesde = document.getElementById('filtro-fecha-desde').value;
      const fechaHasta = document.getElementById('filtro-fecha-hasta').value;
      const modoPago = document.getElementById('filtro-modo-pago').value;
      
      ventasFiltradas = ventasData.filter(venta => {
        const fechaVenta = new Date(venta.fecha_venta).toISOString().split('T')[0];
        
        let cumpleFecha = true;
        if (fechaDesde && fechaVenta < fechaDesde) cumpleFecha = false;
        if (fechaHasta && fechaVenta > fechaHasta) cumpleFecha = false;
        
        let cumplePago = true;
        if (modoPago && !venta.modo_pago.toLowerCase().includes(modoPago.toLowerCase())) {
          cumplePago = false;
        }
        
        return cumpleFecha && cumplePago;
      });
      
      calcularEstadisticasReportes();
      actualizarListaVentasReportes();
    }

    function limpiarFiltrosReportes() {
      document.getElementById('filtro-fecha-desde').value = '';
      document.getElementById('filtro-fecha-hasta').value = '';
      document.getElementById('filtro-modo-pago').value = '';
      
      ventasFiltradas = [...ventasData];
      calcularEstadisticasReportes();
      actualizarListaVentasReportes();
    }

    function calcularEstadisticasReportes() {
      const totalVentas = ventasFiltradas.length;
      const totalDolares = ventasFiltradas.reduce((sum, venta) => sum + (venta.total_dolar || 0), 0);
      const totalBolivares = ventasFiltradas.reduce((sum, venta) => sum + (venta.total_bolivar || 0), 0);
      
      // Contar productos vendidos
      let productosVendidos = 0;
      ventasFiltradas.forEach(venta => {
        if (venta.productos_vendidos) {
          const productos = venta.productos_vendidos.split(';');
          productos.forEach(producto => {
            const match = producto.match(/x(\d+)/);
            if (match) {
              productosVendidos += parseInt(match[1]);
            }
          });
        }
      });
      
      document.getElementById('total-ventas-count').textContent = totalVentas;
      document.getElementById('total-ingresos-dolares').textContent = `$${totalDolares.toFixed(2)}`;
      document.getElementById('total-ingresos-bolivares').textContent = `BsF ${totalBolivares.toFixed(2)}`;
      document.getElementById('productos-vendidos').textContent = productosVendidos;
    }

    function actualizarListaVentasReportes() {
      const lista = document.getElementById('lista-ventas-reportes');
      
      if (ventasFiltradas.length === 0) {
        lista.innerHTML = '<div class="text-center text-gray-500 py-8">No hay ventas que coincidan con los filtros</div>';
        return;
      }
      
      lista.innerHTML = '';
      
      // Ordenar por fecha más reciente
      const ventasOrdenadas = [...ventasFiltradas].sort((a, b) => 
        new Date(b.fecha_venta) - new Date(a.fecha_venta)
      );
      
      ventasOrdenadas.forEach(venta => {
        const fecha = new Date(venta.fecha_venta).toLocaleDateString('es-VE');
        const hora = new Date(venta.fecha_venta).toLocaleTimeString('es-VE');
        
        const div = document.createElement('div');
        div.className = 'bg-white p-3 rounded border border-gray-300 shadow-sm';
        div.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="font-bold text-black">Venta #${venta.id}</div>
              <div class="text-sm text-gray-600">${fecha} - ${hora}</div>
              <div class="text-sm text-black mt-1">
                <strong>Productos:</strong> ${venta.productos_vendidos || 'N/A'}
              </div>
              <div class="text-sm text-black">
                <strong>Método:</strong> ${venta.modo_pago || 'N/A'}
              </div>
              <div class="text-sm text-black">
                <strong>Categorías:</strong> ${venta.categoria || 'N/A'}
              </div>
            </div>
            <div class="text-right">
              <div class="font-bold text-green-600">$${(venta.total_dolar || 0).toFixed(2)}</div>
              <div class="font-bold text-blue-600">BsF ${(venta.total_bolivar || 0).toFixed(2)}</div>
              <button onclick="eliminarVentaReporte('${venta.__backendId}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs mt-1">Eliminar</button>
            </div>
          </div>
        `;
        lista.appendChild(div);
      });
    }

    async function eliminarVentaReporte(backendId) {
      const venta = ventasData.find(v => v.__backendId === backendId);
      if (!venta) return;
      
      // Crear confirmación personalizada
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
          <h3 class="text-lg font-bold mb-4">Confirmar Eliminación</h3>
          <p class="mb-4">¿Estás seguro de eliminar esta venta?</p>
          <p class="mb-4 text-sm text-gray-600">Venta #${venta.id} - $${(venta.total_dolar || 0).toFixed(2)}</p>
          <div class="flex gap-2">
            <button id="btn-confirmar-delete-venta" class="flex-1 bg-red-600 text-white px-4 py-2 rounded">Eliminar</button>
            <button id="btn-cancelar-delete-venta" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('btn-cancelar-delete-venta').onclick = () => {
        document.body.removeChild(modal);
      };
      
      document.getElementById('btn-confirmar-delete-venta').onclick = async () => {
        await window.dataSdk.delete(venta);
        document.body.removeChild(modal);
      };
    }

    function exportarReportesExcel() {
      if (ventasFiltradas.length === 0) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Sin Datos</h3>
            <p class="mb-4">No hay ventas para exportar con los filtros actuales.</p>
            <div class="flex justify-center">
              <button id="btn-cerrar-sin-datos" class="bg-blue-600 text-white px-6 py-2 rounded">Entendido</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('btn-cerrar-sin-datos').onclick = () => {
          document.body.removeChild(modal);
        };
        return;
      }
      
      let csv = 'Fecha,Hora,ID Venta,Productos Vendidos,Modo de Pago,Categorias,Total $,Total BsF\n';
      
      ventasFiltradas.forEach(venta => {
        const fecha = new Date(venta.fecha_venta).toLocaleDateString('es-VE');
        const hora = new Date(venta.fecha_venta).toLocaleTimeString('es-VE');
        
        csv += `${fecha},${hora},${venta.id},"${venta.productos_vendidos || ''}","${venta.modo_pago || ''}","${venta.categoria || ''}",${(venta.total_dolar || 0).toFixed(2)},${(venta.total_bolivar || 0).toFixed(2)}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_ventas_${Date.now()}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function exportarReportesPDF() {
      // Crear mensaje informativo
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
          <h3 class="text-lg font-bold mb-4">📄 Exportar PDF</h3>
          <p class="mb-4">Para exportar a PDF, puedes:</p>
          <ul class="list-disc list-inside mb-4 text-sm">
            <li>Usar el botón "Exportar a Excel" y luego convertir el archivo</li>
            <li>Imprimir esta página como PDF desde tu navegador</li>
          </ul>
          <div class="flex justify-center">
            <button id="btn-cerrar-pdf" class="bg-blue-600 text-white px-6 py-2 rounded">Entendido</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('btn-cerrar-pdf').onclick = () => {
        document.body.removeChild(modal);
      };
    }

    function mostrarGraficos() {
      if (ventasFiltradas.length === 0) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Sin Datos</h3>
            <p class="mb-4">No hay ventas para mostrar gráficos con los filtros actuales.</p>
            <div class="flex justify-center">
              <button id="btn-cerrar-sin-graficos" class="bg-blue-600 text-white px-6 py-2 rounded">Entendido</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('btn-cerrar-sin-graficos').onclick = () => {
          document.body.removeChild(modal);
        };
        return;
      }
      
      document.getElementById('modal-graficos').classList.remove('hidden');
      generarGraficos();
    }

    function cerrarGraficos() {
      document.getElementById('modal-graficos').classList.add('hidden');
    }

    function generarGraficos() {
      // Gráfico de métodos de pago
      const metodosPago = {};
      ventasFiltradas.forEach(venta => {
        const metodos = venta.modo_pago ? venta.modo_pago.split(',') : ['Sin especificar'];
        metodos.forEach(metodo => {
          const metodoLimpio = metodo.trim();
          metodosPago[metodoLimpio] = (metodosPago[metodoLimpio] || 0) + (venta.total_dolar || 0);
        });
      });
      
      dibujarGraficoBarras('grafico-metodos-pago', metodosPago, 'Métodos de Pago');
      
      // Gráfico de categorías
      const categorias = {};
      ventasFiltradas.forEach(venta => {
        const cats = venta.categoria ? venta.categoria.split(',') : ['Sin categoría'];
        cats.forEach(cat => {
          const catLimpia = cat.trim();
          categorias[catLimpia] = (categorias[catLimpia] || 0) + (venta.total_dolar || 0);
        });
      });
      
      dibujarGraficoBarras('grafico-categorias', categorias, 'Categorías');
      
      // Gráfico de ventas diarias
      const ventasDiarias = {};
      ventasFiltradas.forEach(venta => {
        const fecha = new Date(venta.fecha_venta).toLocaleDateString('es-VE');
        ventasDiarias[fecha] = (ventasDiarias[fecha] || 0) + (venta.total_dolar || 0);
      });
      
      dibujarGraficoLineas('grafico-ventas-diarias', ventasDiarias, 'Ventas Diarias');
    }

    function dibujarGraficoBarras(canvasId, datos, titulo) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      
      // Limpiar canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const labels = Object.keys(datos);
      const valores = Object.values(datos);
      
      if (labels.length === 0) {
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No hay datos', canvas.width / 2, canvas.height / 2);
        return;
      }
      
      const maxValor = Math.max(...valores);
      const barWidth = canvas.width / labels.length * 0.8;
      const barSpacing = canvas.width / labels.length * 0.2;
      
      // Dibujar barras
      labels.forEach((label, index) => {
        const valor = valores[index];
        const barHeight = (valor / maxValor) * (canvas.height - 40);
        const x = index * (barWidth + barSpacing) + barSpacing / 2;
        const y = canvas.height - barHeight - 20;
        
        // Barra
        ctx.fillStyle = `hsl(${index * 60}, 70%, 50%)`;
        ctx.fillRect(x, y, barWidth, barHeight);
        
        // Etiqueta
        ctx.fillStyle = '#333';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(label.substring(0, 8), x + barWidth / 2, canvas.height - 5);
        
        // Valor
        ctx.fillText(`$${valor.toFixed(0)}`, x + barWidth / 2, y - 5);
      });
    }

    function dibujarGraficoLineas(canvasId, datos, titulo) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      
      // Limpiar canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const labels = Object.keys(datos).sort();
      const valores = labels.map(label => datos[label]);
      
      if (labels.length === 0) {
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No hay datos', canvas.width / 2, canvas.height / 2);
        return;
      }
      
      const maxValor = Math.max(...valores);
      const stepX = canvas.width / (labels.length - 1 || 1);
      
      // Dibujar línea
      ctx.strokeStyle = '#16a34a';
      ctx.lineWidth = 2;
      ctx.beginPath();
      
      labels.forEach((label, index) => {
        const valor = valores[index];
        const x = index * stepX;
        const y = canvas.height - 20 - (valor / maxValor) * (canvas.height - 40);
        
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
        
        // Punto
        ctx.fillStyle = '#16a34a';
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, 2 * Math.PI);
        ctx.fill();
        
        // Etiqueta
        ctx.fillStyle = '#333';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(label.substring(5), x, canvas.height - 5);
      });
      
      ctx.stroke();
    }

    // Función para guardar la tasa del dólar
    async function guardarTasaDolar(nuevaTasa) {
      try {
        // Buscar si ya existe una configuración
        const configExistente = todosLosDatos.find(item => item.tipo === 'configuracion');
        
        if (configExistente) {
          // Actualizar configuración existente
          const configActualizada = {
            ...configExistente,
            tasa_dolar: nuevaTasa,
            fecha_actualizacion: new Date().toISOString()
          };
          
          const result = await window.dataSdk.update(configActualizada);
          if (result.isOk) {
            mostrarMensaje('✅ Tasa Guardada', `La tasa del dólar ha sido actualizada a BsF ${nuevaTasa.toFixed(2)}`, 'success');
          }
        } else {
          // Crear nueva configuración
          const nuevaConfig = {
            id: 'config_principal',
            tipo: 'configuracion',
            tasa_dolar: nuevaTasa,
            fecha_creacion: new Date().toISOString(),
            fecha_actualizacion: new Date().toISOString()
          };
          
          const result = await window.dataSdk.create(nuevaConfig);
          if (result.isOk) {
            mostrarMensaje('✅ Tasa Guardada', `La tasa del dólar ha sido establecida en BsF ${nuevaTasa.toFixed(2)}`, 'success');
          }
        }
      } catch (error) {
        console.error('Error al guardar tasa:', error);
        mostrarMensaje('❌ Error', 'No se pudo guardar la tasa del dólar', 'error');
      }
    }

    // Función para mostrar mensajes al usuario
    function mostrarMensaje(titulo, mensaje, tipo = 'info') {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      
      const colorClase = tipo === 'success' ? 'text-green-600' : tipo === 'error' ? 'text-red-600' : 'text-blue-600';
      const colorBoton = tipo === 'success' ? 'bg-green-600 hover:bg-green-700' : tipo === 'error' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700';
      
      modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
          <h3 class="text-lg font-bold mb-4 ${colorClase}">${titulo}</h3>
          <p class="mb-4">${mensaje}</p>
          <div class="flex justify-center">
            <button id="btn-cerrar-mensaje" class="${colorBoton} text-white px-6 py-2 rounded">Entendido</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('btn-cerrar-mensaje').onclick = () => {
        document.body.removeChild(modal);
      };
      
      // Auto-cerrar después de 3 segundos para mensajes de éxito
      if (tipo === 'success') {
        setTimeout(() => {
          if (document.body.contains(modal)) {
            document.body.removeChild(modal);
          }
        }, 3000);
      }
    }

    window.editarProducto = editarProducto;
    window.eliminarProducto = eliminarProducto;
    window.eliminarItemVenta = eliminarItemVenta;
    window.eliminarVentaReporte = eliminarVentaReporte;

    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99b678cd84113eeb',t:'MTc2MjYxOTYwNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>